#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get the push arguments
PUSH_COMMAND="$*"

# Check if it's only a branch deletion (contains --delete or -d)
if echo "$PUSH_COMMAND" | grep -qE -- "--delete|-d"; then
  echo "Branch deletion detected, skipping tests..."
  exit 0
fi

# Function to run a command and report its status
run_check() {
  local check_name="$1"
  local command="$2"
  echo "ğŸ” Running $check_name..."
  
  if eval "$command"; then
    echo "âœ… $check_name passed"
    return 0
  else
    echo "âŒ $check_name failed"
    echo "âš ï¸  Push blocked due to failing $check_name"
    echo "ğŸ’¡ Fix the issues above, don't use --no-verify to bypass!!"
    return 1
  fi
}

# Run comprehensive checks before pushing
echo "ğŸš€ Running pre-push checks..."
echo "=================================================="

# 1. Lint check
run_check "Linting" "pnpm lint" || exit 1

# 2. Test check with better error reporting
echo "ğŸ§ª Running tests..."
if ! pnpm test; then
  echo "âŒ Tests failed"
  echo "ğŸ“‹ Common issues to check:"
  echo "   â€¢ Missing dependencies (run: pnpm install)"
  echo "   â€¢ Test logic errors (check test output above)"
  echo "   â€¢ Async timing issues (check waitFor timeouts)"
  echo "   â€¢ Mock configuration problems"
  echo "âš ï¸  Push blocked due to failing tests"
  echo "ğŸ’¡ Fix the issues above; don't use --no-verify to bypass!!"
  exit 1
else
  echo "âœ… Tests passed"
fi

# 3. Build check
run_check "Build" "pnpm build" || exit 1

# 4. Accessibility tests (TEMPORARILY DISABLED)
echo "â­ï¸  Accessibility tests temporarily disabled"
echo "ğŸ“‹ Note: A11y tests need configuration fixes before re-enabling"
echo "ğŸ’¡ See backlog: 'Fix accessibility test configuration and re-enable in CI'"

# TODO: Re-enable when accessibility tests are fixed
# echo "ğŸ” Checking for accessibility tests..."
# if grep -q '"test:a11y"' package.json 2>/dev/null; then
#   echo "ğŸ“‹ Accessibility tests found in package.json, running with detailed output..."
#   echo "ğŸ” Running accessibility tests with verbose logging..."
#   
#   # Run with timeout and show more details about what's happening
#   if timeout 600 pnpm run test:a11y; then
#     echo "âœ… Accessibility tests passed"
#   else
#     echo "âŒ Accessibility tests failed or timed out"
#     echo "ğŸ“‹ Common accessibility issues to check:"
#     echo "   â€¢ Missing aria-labels on interactive elements"
#     echo "   â€¢ Insufficient color contrast ratios"
#     echo "   â€¢ Missing semantic HTML structure"
#     echo "   â€¢ Keyboard navigation issues"
#     echo "âš ï¸  Push blocked due to failing accessibility tests"
#     echo "ğŸ’¡ Fix the issues above; don't use --no-verify to bypass!!"
#     exit 1
#   fi
# else
#   echo "â­ï¸  Accessibility tests not available in this package, skipping"
#   echo "ğŸ’¡ To enable a11y tests, add 'test:a11y' script to package.json"
# fi

echo "=================================================="
echo "âœ… All pre-push checks passed! ğŸ‰"
echo "ğŸš€ Proceeding with push..."  