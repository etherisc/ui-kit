#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get the push arguments
PUSH_COMMAND="$*"

# Check if it's only a branch deletion (contains --delete or -d)
if echo "$PUSH_COMMAND" | grep -qE -- "--delete|-d"; then
  echo "Branch deletion detected, skipping tests..."
  exit 0
fi

# Function to run a command and report its status
run_check() {
  local check_name="$1"
  local command="$2"
  echo "ğŸ” Running $check_name..."
  
  if eval "$command"; then
    echo "âœ… $check_name passed"
    return 0
  else
    echo "âŒ $check_name failed"
    echo "âš ï¸  Push blocked due to failing $check_name"
    echo "ğŸ’¡ Fix the issues above, don't use --no-verify to bypass!!"
    return 1
  fi
}

# Run comprehensive checks before pushing
echo "ğŸš€ Running pre-push checks..."
echo "=================================================="

# 1. Lint check
run_check "Linting" "pnpm lint" || exit 1

# 2. Test check with better error reporting
echo "ğŸ§ª Running tests..."
if ! pnpm test; then
  echo "âŒ Tests failed"
  echo "ğŸ“‹ Common issues to check:"
  echo "   â€¢ Missing dependencies (run: pnpm install)"
  echo "   â€¢ Test logic errors (check test output above)"
  echo "   â€¢ Async timing issues (check waitFor timeouts)"
  echo "   â€¢ Mock configuration problems"
  echo "âš ï¸  Push blocked due to failing tests"
  echo "ğŸ’¡ Fix the issues above; don't use --no-verify to bypass!!"
  exit 1
else
  echo "âœ… Tests passed"
fi

# 3. Build check
run_check "Build" "pnpm build" || exit 1

# 4. Accessibility tests (if available)
if pnpm run test:a11y --if-present >/dev/null 2>&1; then
  run_check "Accessibility tests" "pnpm run test:a11y" || exit 1
else
  echo "â­ï¸  Accessibility tests not available, skipping"
fi

echo "=================================================="
echo "âœ… All pre-push checks passed! ğŸ‰"
echo "ğŸš€ Proceeding with push..."  